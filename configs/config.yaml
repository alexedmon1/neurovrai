# MRI Preprocessing Pipeline Configuration
# Generated for: /mnt/bytopia/IRC805
#
# IMPORTANT: Review and customize before using!
# - Verify all paths are correct
# - Check sequence-specific parameters (TR, TE, readout_time)
# - Adjust processing parameters based on your needs
#
# Directory Structure:
#   /mnt/bytopia/IRC805/
#   ├── raw/dicom/           # Raw DICOM files (input)
#   ├── bids/                # Converted NIfTI files (created by pipeline)
#   ├── derivatives/         # Preprocessed outputs
#   ├── work/                # Temporary Nipype files (can be deleted)
#   ├── qc/                  # Quality control reports
#   ├── logs/                # Log files
#   └── transforms/          # Spatial transformation matrices
#
# Usage:
#   # Single subject
#   uv run python run_simple_pipeline.py --subject SUB_ID --dicom-dir /mnt/bytopia/IRC805/raw/dicom/SUB_ID --config config.yaml
#
#   # Batch processing
#   uv run python run_batch_simple.py --config config.yaml
#

project_dir: /mnt/bytopia/IRC805
dicom_dir: /mnt/bytopia/IRC805/raw/dicom
bids_dir: /mnt/bytopia/IRC805/bids
derivatives_dir: /mnt/bytopia/IRC805/derivatives
work_dir: /mnt/bytopia/IRC805/work
paths:
  logs: /mnt/bytopia/IRC805/logs
  transforms: /mnt/bytopia/IRC805/transforms
  qc: /mnt/bytopia/IRC805/qc
execution:
  plugin: MultiProc
  n_procs: 6
  hash_method: content  # Enable caching based on file content (not timestamps)
  stop_on_first_crash: false
  keep_inputs: false
  remove_unnecessary_outputs: true
templates:
  mni152_t1_2mm: /usr/local/fsl/data/standard/MNI152_T1_2mm_brain.nii.gz
  mni152_t1_1mm: /usr/local/fsl/data/standard/MNI152_T1_1mm_brain.nii.gz
  fmrib58_fa: /usr/local/fsl/data/standard/FMRIB58_FA_1mm.nii.gz
anatomical:
  bet:
    frac: 0.5
    reduce_bias: true
    robust: true
  bias_correction:
    n_iterations: [50, 50, 30, 20]  # N4 multi-resolution iterations
    shrink_factor: 3                 # Downsampling for speed
    convergence_threshold: 0.001     # Convergence criterion
    bspline_fitting_distance: 300    # B-spline mesh resolution
  segmentation_method: ants
  atropos:
    number_of_tissue_classes: 3      # CSF, GM, WM
    initialization: KMeans           # KMeans, Otsu, or PriorProbabilityImages
    n_iterations: 5
    convergence_threshold: 0.001
    mrf_smoothing_factor: 0.1
    mrf_radius: [1, 1, 1]            # Markov Random Field spatial smoothing radius
  registration_method: ants  # Default: 'ants' (SyN) for robust registration; 'fsl' for FLIRT+FNIRT
  run_qc: true
diffusion:
  denoise_method: dwidenoise
  bet:
    frac: 0.3  # Lower than anatomical (0.5) - DWI has lower contrast
  topup:
    enabled: auto
    readout_time: 0.05
  eddy_config:
    flm: linear
    slm: linear
    use_cuda: true
  bedpostx:
    enabled: true  # Fiber orientation estimation (required for connectomics)
    use_gpu: true  # GPU-accelerated (20-60 min vs 4-8 hours CPU)
    n_fibres: 2    # Number of fiber populations per voxel
    burnin: 1000   # MCMC burn-in period
    n_jumps: 1250  # MCMC jumps after burn-in
  advanced_models:
    enabled: auto
    fit_dki: true
    fit_noddi: true
    fit_sandi: false
    fit_activeax: false
    use_amico: true
  run_qc: true
functional:
  tr: 1.029
  te:
  - 10.0
  - 30.0
  - 50.0
  bet:
    frac: 0.3  # Lower than anatomical - functional has lower contrast
  highpass: 0.001
  lowpass: 0.08
  fwhm: 6
  normalize_to_mni: true
  tedana:
    enabled: true
    tedpca: 225  # Manual PCA: 450 volumes / 2 = 225 components (improved ICA convergence)
                 # Options: 'kundu' (auto), 'aic', 'kic', 'mdl', float (0-1 variance), or int (num components)
    tree: kundu
  aroma:
    enabled: auto
  acompcor:
    enabled: true
    num_components: 5
    variance_threshold: 0.5
  run_qc: true
asl:
  labeling_type: pcasl
  labeling_duration: 1.932
  post_labeling_delay: 2.031
  bet:
    frac: 0.3  # Lower than anatomical - ASL has lower contrast
  labeling_efficiency: 0.85
  t1_blood: 1.65
  blood_brain_partition: 0.9
  label_control_order: control_first
  background_suppression_pulses: 1
  apply_m0_calibration: true
  wm_cbf_reference: 25.0
  apply_pvc: false
  normalize_to_mni: false
  run_qc: true
freesurfer:
  enabled: false
  subjects_dir: /mnt/bytopia/IRC805/freesurfer
  use_for_masks: false

# Structural Connectivity (Tractography-based)
# Requires: BEDPOSTX outputs, atlas parcellation
structural_connectivity:
  # Tractography engine settings
  tractography:
    use_gpu: true                    # Use probtrackx2_gpu if available (much faster)
    n_samples: 5000                  # Samples per seed voxel (higher = more accurate, slower)
    step_length: 0.5                 # Step length in mm
    curvature_threshold: 0.2         # Curvature threshold (0-1, lower = straighter paths)
    loop_check: true                 # Discard looping streamlines

  # Anatomical constraints (improves biological plausibility)
  anatomical_constraints:
    avoid_ventricles: true           # Exclude CSF/ventricles from tractography (recommended)
    use_wm_mask: true                # Constrain tractography to white matter (ACT-style)
    terminate_at_gm: false           # Stop streamlines when entering gray matter
    wm_source: auto                  # 'freesurfer' (aparc+aseg WM), 'fsl' (FAST pve_2), or 'auto'

  # FreeSurfer-enhanced tractography (requires freesurfer.enabled: true)
  freesurfer_options:
    use_gmwmi_seeding: false         # Seed from gray-white matter interface (more anatomically precise)
    gmwmi_method: surface            # 'surface' (lh/rh.white) or 'volume' (aparc+aseg boundary)
    use_subcortical_waypoints: false # Use thalamus/basal ganglia as waypoint constraints
    subcortical_structures:          # Structures to use as waypoints (FreeSurfer label names)
      - Left-Thalamus
      - Right-Thalamus

  # Atlas settings
  atlas:
    default: schaefer_200            # Default atlas for connectivity
    available:                       # Additional atlases to compute
      - schaefer_100
      - schaefer_200
      - schaefer_400
      - desikan_killiany             # Requires FreeSurfer

  # Output settings
  output:
    normalize: true                  # Normalize by waytotal
    threshold: null                  # Optional threshold for weak connections (0-1)
    compute_graph_metrics: true      # Compute graph-theoretic network measures
    save_streamlines: false          # Save full streamline data (large files)

  run_qc: true
