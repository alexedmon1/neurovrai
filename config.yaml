# MRI Preprocessing Pipeline Configuration
# Based on README.md specification

# Project paths
project_dir: /mnt/bytopia/IRC805
rawdata_dir: ${project_dir}/subjects  # IRC805 uses 'subjects' instead of 'rawdata'
derivatives_dir: ${project_dir}/derivatives
work_dir: ${project_dir}/work

# Path structure for workflows
paths:
  logs: ${project_dir}/logs
  transforms: ${project_dir}/transforms

# Execution settings
execution:
  plugin: MultiProc
  n_procs: 6

# Template files
templates:
  mni152_t1_2mm: /usr/local/fsl/data/standard/MNI152_T1_2mm_brain.nii.gz
  mni152_t1_1mm: /usr/local/fsl/data/standard/MNI152_T1_1mm_brain.nii.gz

# Anatomical preprocessing
anatomical:
  bet:
    frac: 0.5
    reduce_bias: true
    robust: true
  segmentation_method: ants  # 'ants' (Atropos) or 'fsl' (FAST)
  atropos:
    n_iterations: 5
    convergence_threshold: 0.001
    mrf_smoothing_factor: 0.1
  registration_method: fsl  # or 'ants'
  run_qc: true

# Diffusion preprocessing
diffusion:
  denoise_method: dwidenoise
  topup:
    enabled: auto  # 'auto' (use if reverse PE available), true, or false
    readout_time: 0.05
  eddy_config:
    flm: linear
    slm: linear
    use_cuda: true

  # Advanced diffusion models (DKI, NODDI, SANDI, ActiveAx)
  # Auto-enabled for multi-shell data (≥2 non-zero b-values)
  advanced_models:
    enabled: auto  # true, false, or 'auto' (default: auto-detect multi-shell)
    fit_dki: true  # Diffusion Kurtosis Imaging (DIPY)
    fit_noddi: true  # NODDI via AMICO (100x faster) or DIPY
    fit_sandi: false  # SANDI via AMICO (requires ≥3 shells)
    fit_activeax: false  # ActiveAx via AMICO (requires specific protocol)
    use_amico: true  # Use AMICO for NODDI/SANDI/ActiveAx (recommended)

  run_qc: true

# Functional preprocessing
functional:
  tr: 1.029
  te: [10.0, 30.0, 50.0]
  highpass: 0.001
  lowpass: 0.08
  fwhm: 6
  normalize_to_mni: true  # Reuse anatomical transforms for normalization
  tedana:
    enabled: true
    tedpca: kundu
    tree: kundu
  aroma:
    enabled: false  # Redundant with TEDANA
  acompcor:
    enabled: true
    num_components: 5
    variance_threshold: 0.5
  run_qc: true

# FreeSurfer integration (use existing FreeSurfer outputs)
freesurfer:
  enabled: false  # Set to true to use existing FreeSurfer outputs
  subjects_dir: ${project_dir}/freesurfer  # Path to SUBJECTS_DIR
  use_for_tractography: true  # Use FreeSurfer ROIs for tractography
  use_for_masks: true  # Use FreeSurfer tissue masks

# ASL (Arterial Spin Labeling) preprocessing
asl:
  labeling_type: pcasl  # 'pcasl' or 'pasl'
  labeling_duration: 1.932  # τ (tau) in seconds [Extracted from DICOM tag 2005,140a]
  post_labeling_delay: 2.031  # PLD in seconds [Extracted from DICOM tag 2005,1442]
  labeling_efficiency: 0.85  # α (alpha) for pCASL
  t1_blood: 1.65  # T1 of blood at 3T in seconds
  blood_brain_partition: 0.9  # λ (lambda) in ml/g
  label_control_order: control_first  # 'control_first' or 'label_first' [Confirmed by DICOM tag 2005,1429]
  background_suppression_pulses: 1  # [Extracted from DICOM tag 2005,1412]

  # M0 calibration with white matter reference
  apply_m0_calibration: true  # Correct for M0 estimation bias using WM reference
  wm_cbf_reference: 25.0  # Expected WM CBF in ml/100g/min (literature value)

  # Partial volume correction
  apply_pvc: false  # Apply linear regression PVC method (requires tissue masks)

  normalize_to_mni: false  # Reuse anatomical transforms for normalization
  run_qc: true
